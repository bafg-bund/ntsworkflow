---
title: "Einleitung zur DB-screening mit ntsworkflow"
author: "Referat G2 (Gewässerchemie), Bundesanstalt für Gewässerkunde"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DB-Screening_de}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(ggplot2)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Einleitung

Die Datenauswertung mit Hilfe der MS^2^ Spektrendatenbank erfolgt in der Kommandozeile und die Veranschaulichung der Ergebnisse in dem browserbasierten Visualisierungstool. Dieses Dokument umreißt grob den Ablauf dieses Vorgangs. Weitere Einzelheiten zu den spezifischen R-Funktionen finden Sie in der Dokumentation im ntsworkflow-Paket.

# Schritt-für-Schritt Anleitung
## Schritt 1 
Beim Ausführen von ntsworkflow erfolgt eine Warnung, diese ist normal.
```{r, message=FALSE, warning=FALSE}
library(ntsworkflow)
```

## Schritt 2 
Erstellen Sie ein neues "Report" Objekt. Der Name "test" kann beliebig gewählt werden, so lang dieser mit einem Buchstaben beginnt und nicht schon von R verwendet wird.

```{r}
test <- Report$new()
```

## Schritt 3 
Laden Sie einige Roh-Dateien in den Report. Dies geht entweder interaktiv durch Ausführen von: 
```{r, eval = FALSE}
test$addRawFiles()
```

...oder Sie können auch den Dateipfad direkt eingeben, z.B.: 
```{r}
listOfFiles <- c(
    "example1.mzXML",
    "example2.mzXML"
  )
test$addRawFiles(dialog = FALSE, normalizePath(listOfFiles))
```

Sie können sich durch Ausführen von: `*$rawFiles`, ansehen welche Dateien sich in dem Report befinden. Die Indexnummer entspricht dabei der Position der Datei im Report.
```{r}
test$rawFiles
```

## Schritt 4 
Importieren Sie eine IS Tabelle. Diese Tabelle muss eine CSV-Datei mit 4 Spalten sein: name, formula, rt, adduct. In dieser muss "formula" für z.B. CBZ-IS "formula" in der Form "C14 13CH12N 15NO" und "adduct" in der Form: [M+H]+, [M]+, etc. eingetragen sein. Dieser Schritt kann ebenfalls mit einer Dialogauswahl oder direkt über den Dateipfad erfolgen.
```{r}
# With prompt: test$addIS()
test$addIS(dialog = FALSE, "IS_table_pos.csv")
```
```{r}
test$IS
```

## Schritt 5 
Die Einstellungen wurden bereits mit Standardwerten versehen. Zum Betrachten der Einstellungen:
```{r, eval=FALSE}
test$settings
```

```{r, results='asis', echo=FALSE}
values <- sapply(test$settings, function(x) if (length(x) > 1) Reduce(paste, x) else paste(x))
values[1] <- "D:/Example/sqlite/MS2db.db"
knitr::kable(data.frame(Name = names(test$settings), Value = values), row.names = FALSE,
             caption = "Settings used by the suspect search algorithm")
```

Für detaillierte Erklärungen, was die einzelnen Einstellungen bewirken, betrachten Sie bitte die Dokumentation der "Report" Klassen. Zum Beispiel durch die Eingabe von: `help("Report-class")`.

### Verbindung zur Datenbank

Die Variable `db_path` muss zum Speicherort der Datenbank geändert werden. Um irgendeine Einstellung zu ändern wird die Funktion `*$changeSettings(parameter, value)` benutzt. Dabei entspricht "parameter" dem Namen der zu ändernden Variable und "value" dem Wert auf welche Sie geändert wird. Um zu erfahren, welche Möglichkeiten es bei den Einstellungen gibt, sollten Sie die Dokumentation konsultieren.
```{r}
test$addDB(dialog = FALSE, "example_database.db")
```

## Schritt 6 
Das Verarbeiten der Dateien wird in diesem Beispiel ungefähr 5 Minuten in Anspruch nehmen, kann aber auch deutlich länger dauern. Alle Dateien, welche noch bearbeitet werden, werden in den Arbeitsspeicher (RAM) gelanden. Sollten Sie nicht viel Arbeitsspeicher haben, nutzen Sie die Möglichkeit die Dateien in "Batches" zu laden und zu verarbeiten. Um Dateien aus dem RAM zu löschen, benutzen Sie `*.clearData()`. 
Während des gesamten Prozesses erscheinen einige Informationen in der Konsole.
```{r, message=FALSE, warning=FALSE}
test$process_all()
```

Die Ergebnisse werden in verschiedenen Tabellen gesammelt. Die Hauptergebnisdatei, die Peakliste, wird unter dem Namen `*$peakList` erstellt. Dabei handelt es sich um einen `data.frame`. Um auf diese Datei zuzugreifen nutzen Sie zum Beispiel den Befehl: `test$peakList[1:10, c(1:3, 13)]`.
```{r, results="asis", echo=FALSE}
knitr::kable(test$peakList[1:2, c(1:2,22,12:13)], caption="Excerpt of the peak list")
```

Es gibt ebenfalls eine Tabelle, in welcher die Ergebnisse der IS Integration gesammelt werden.
```{r, results="asis", echo=FALSE}
knitr::kable(test$ISresults[, 1:5], caption = "IS integration results")
```

Wenn Sie sich einen bestimmten Komponentenpeak oder ein Spektrum ansehen wollen, nutzen Sie diese Methode:
```{r, fig.cap="EIC plot from peak with ID 21, lamotrigine in this case.", fig.width=5, fig.height=3}
test$plotEIC(1)  # you must provide the peakID, which is found in the peak list
```

\pagebreak

```{r, fig.cap="MS^1^ plot from peak with ID 21, lamotrigine in this case.", fig.width=5, fig.height=3}
test$plotMS1(1)
```

```{r, fig.cap="MS^2^ plot from peak with ID 21, lamotrigine in this case.", fig.width=5, fig.height=3}
test$plotMS2(1)
```

In den MS^2^ Spektren zeigt die Punktzahl von 0 bis 1000 wie gut die Übereinstimmung mit der Datenbank ist. (Siehe dot_product algorithm "purity").[^1]

[^1]: Sokolow S, Karnofsky J, Gustafson P. The Finnigan Library Search Program, 1978.

# Betrachten der Ergebnisse

Beim Ausführen des Befehls: `test$view()` startet die Visualisierungsapplikation. Dabei handelt es sich um eine interaktive Umgebung mit der man die Ergebnisse betrachten kann. Diese Anzeige ist shiny basiert.

Hier befinden sich verschiedene Reiter:

## Peak list
![The Peaklist tab](images/peaklist.png){#id .class width=300px}

Sie können eine Komponente markieren und dann den Reiter "view" aktivieren, um das Spektrum zu betrachten. Das gezeigte Bild ist aus einer vollständigen Datenauswertung und nicht aus dem oben gezeigten Beispiel.

## View
Hier können Sie das EIC, das MS^1^ und das MS^2^ Spektrum der markierten Komponente aus dem "Peak List" Reiter betrachten. Dabei besteht die Möglichkeit direkt die Peak ID einzugeben oder durch scrollen alle Peaks zu betrachten.

![The View tab](images/spectra.png){#id .class width=300px}

## IS
Hier werden die Ergebnisse der IS Integration gezeigt.

## View IS
Die Peakfläche, Weite und Retentionszeitstabilität für alle IS in allen Proben werden hier dargestellt.

## Trend
Dieser Reiter zeigt die Intensitätsverläufe (Fläche oder Höhe) aller Komponenten in allen Proben. Es gibt zudem die Möglichkeit, durch den IS normalisierte Werte zu betrachten.
Dunkelblau bedeutet, dass die Komponente durch ihr MS^2^ Spektrum identifiziert wurde. Hellblau bedeutet, dass die Peakfläche durch Reintegration ermittelt wurde (siehe unten). Und Rot bedeutet, dass kein IS in dieser Probe gefunden wurde, weswegen die IS Flächen Berechnung auf Grund vorheriger Proben erfolgt ist. Durch Zoomen in ein Diagramm wird ein Peak ausgewählt (erkennbar am gelben Hintergrund). Dieser Peak kann im Reiter "view" betrachtet werden.

![The Trend tab](images/trend.png){#id .class width=300px}

# False positives

Wenn Sie ein "false positiv" bemerken, können Sie diesen durch Ausführen des Befehls `test$deleteFP(name)` entfernen. Dabei steht "name" für die Komponente, die gelöscht werden soll, und die Bezeichnung muss exakt sein (Groß- und Kleinschreibung, Bindestriche, Kommata etc.). Deshalb ist es sinnvoll den Namen aus der Peakliste zu kopieren.
```{r, eval=FALSE}
test$deleteFP("Benzyl-dimethyl-hexadecylammonium")
```

Zudem wird diese Komponente in dem `test$falsePos` Feld eingetragen. Jede Komponente, die dort eingetragen wird, wird von zukünftigen Verarbeitungsergebnissen ausgeschlossen. Um dies verhindern, muss diese wieder aus dem `falsePos` Feld gelöscht werden. Ein Beispiel wäre:

```{r, eval=FALSE}
test$falsePos <- test$falsePos[test$falsePos != "Guanosine"]
```

# Blindabzug

Wenn Sie zudem eine oder mehrere Blindwert Proben mitverarbeitet haben, gibt es die Möglichkeit, die darin gefundenen Peaks zu entfernen `test$deleteBackground(indicesData, indicesBlank, includeIS = FALSE)`. Hierbei werden einfach die Namen der Komponenten, die in den Blindproben und den Proben gefunden wurden, miteinander verglichen. Dabei müssen beide Peaks derselben Komponente zugewiesen werden. Wenn in einer Datei nun aber die Intensität `NA` (also nicht gefunden wurde) ist, so wird diese übersprungen und nicht gelöscht.
Sie müssen die Proben und Blindwerte anhand des Indexes aus `test$rawFiles` festlegen. Wenn es Probleme mit den Hintergrundsignalen im IS gibt, können die durch den Befehl `includeIS = TRUE` ebenfalls gelöscht werden. In der Grundeinstellung muss die Intensität einer Komponente in einer Probe 5x höher sein als im Blindwert, damit dieser erhalten bleibt. Diese Einstellung kann mit dem Befehl: `test$settings$blank_int_factor` geändert werden.

```{r, eval = FALSE}
test$deleteBackground(3, 2)  # will not delete IS peaks
test$deleteBackground(3, 2, includeIS = TRUE)
```


# Peakintensität von "NA"

Eine Peakintensität von "NA" bedeutet, dass die Integration fehlgeschlagen ist. Diese Peaks können einfach entfernt werden.

```{r, eval=FALSE}
test$peakList <- test$peakList[!is.na(test$peakList$int_a), ]
```

# Reintegration

Manchmal existiert kein MS^2^ Spektrum und dadurch wird die Komponente in einer Probe in einer langen Serie nicht gefunden. In so einem Fall kann man alle Proben reintegrieren  in dem man die exakte Masse und Retentionszeit jeder gefundenen möglichen Komponente verwendet. In dieser Variante wird dann kein MS^2^ Abgleich vorgenommen. Dies dient nur einer besser Trenderzeugung.
Wichtig ist hierbei, dass das Programm zum Teil auch versucht das Rauschen zu integrieren, somit sieht man zum Teil das Grundsignal als Intensität.
```{r, eval=FALSE}
test$reIntegrate()
```

Um die Ergebnisse der Reintegration zu sehen benutzt man den Befehl `test$view()` oder `test$integRes`.

# Speichern und Laden für spätere Nutzung

## Einstellungen
Um die Einstellungen für später zu speichern:
```{r, eval=FALSE}
test$saveSettings()
```

Dieser Befehl speichert die aktuellen Einstellungen in einer .json Datei. Diese kann wieder geladen werden indem man den Befehl: `test$loadsettings()` benutzt

## Speichern und Laden des Reports

Sie können ihre Ergebnisse in einer `.report` Datei speichern. Ehe die Datei gespeichert wird, werden alle Dateien aus dem RAM entfernt.
```{r, eval=FALSE}
test$clearAndSave()

# Or, if you want to give it another name or location
test$clearAndSave("D:\\testFolder\\example_test")  
```

Um eine .report Datei wieder in die R Umgebung zu laden:
```{r, eval=FALSE}
newName <- ntsworkflow::loadReport("example_test.report")
```

Sie können jede Tabelle in ihrem Report als eine .csv Datei speichern. Dafür sollte der Befehl `write.csv2` genutzt werden. Für englische Excel Varianten `write.csv`.
```{r, eval=FALSE}
write.csv2(test$peakList, file = "new_peaklist.csv")
```


